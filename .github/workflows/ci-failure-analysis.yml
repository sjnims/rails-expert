name: CI Failure Analysis

# Automatically analyze failed CI runs and provide actionable fix suggestions
# Triggers when any lint workflow fails (Markdown, Ruby, YAML, Links, Workflows)
#
# Testing: Intentionally fail markdownlint (e.g., change - to * in any .md file)

on:
  workflow_run:
    workflows:
      - "Markdown Lint"
      - "Ruby Lint"
      - "YAML Lint"
      - "Shell Lint"
      - "Check Links"
      - "Validate Workflows"
    types: [completed]

# Cancel in-progress analysis for same workflow run
concurrency:
  group: ${{ github.workflow }}-${{ github.event.workflow_run.id }}
  cancel-in-progress: true

jobs:
  analyze-failure:
    name: Analyze CI Failure
    # Only run on failure, skip bot triggers to prevent loops
    if: |
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.actor.login != 'dependabot[bot]' &&
      github.event.workflow_run.actor.login != 'claude[bot]'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write
      actions: read
      id-token: write

    steps:
      # NOTE: No checkout needed - gh CLI accesses logs directly via API.
      # Avoiding checkout prevents untrusted code execution in workflow_run context.
      # See: https://securitylab.github.com/research/github-actions-preventing-pwn-requests/

      - name: Analyze failure with Claude
        uses: anthropics/claude-code-action@c9ec2b02b40ac0444c6716e51d5e19ef2e0b8d00 # v1.0.28
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            A CI workflow has failed. Analyze the failure and help the developer fix it.

            ## Failed Workflow Details

            - **Workflow**: ${{ github.event.workflow_run.name }}
            - **Run ID**: ${{ github.event.workflow_run.id }}
            - **Run URL**: ${{ github.event.workflow_run.html_url }}
            - **Commit SHA**: ${{ github.event.workflow_run.head_sha }}
            - **Branch**: ${{ github.event.workflow_run.head_branch }}
            - **Actor**: ${{ github.event.workflow_run.actor.login }}
            - **Repository**: ${{ github.repository }}

            ## Instructions

            ### Step 1: Get the failure logs

            First, download and examine the workflow run logs:

            ```bash
            gh run view ${{ github.event.workflow_run.id }} --log
            ```

            If that's too verbose, get the job summary first:

            ```bash
            gh run view ${{ github.event.workflow_run.id }} --json jobs --jq '.jobs[] | select(.conclusion == "failure") | {name: .name, conclusion: .conclusion}'
            ```

            ### Step 2: Analyze the failure

            Based on which workflow failed, look for specific error patterns:

            **For "Markdown Lint" failures:**
            - Look for lines like: `filename:line:column MD00X/rule-name message`
            - Common issues: wrong list style (should use `-`), wrong header style (should use ATX `#`)

            **For "YAML Lint" (yamllint) failures:**
            - Look for lines like: `filename:line:column [error] message (rule-name)`
            - Common issues: wrong indentation (should use 2 spaces), trailing spaces, missing newline at end of file

            **For "Check Links" (lychee) failures:**
            - Look for broken URLs with HTTP status codes (404, 403, etc.)
            - Check if the URL has moved or if it's a false positive

            **For "Validate Workflows" (actionlint) failures:**
            - Look for YAML syntax errors or invalid workflow configurations
            - Check for missing required fields, invalid expressions, or deprecated syntax

            **For "Ruby Lint" (RuboCop) failures:**
            - Look for lines like: `filename:line:column: C: CopName: message`
            - Common issues: style violations, naming conventions, code complexity
            - Auto-fix available: `rubocop -a` for safe fixes, `rubocop -A` for all auto-corrections

            **For "Shell Lint" (ShellCheck) failures:**
            - Look for lines like: `In filename line column: note/warning/error: [SC####]: message`
            - Common issues: unquoted variables, missing quotes, deprecated syntax
            - Check ShellCheck wiki for specific error codes: https://www.shellcheck.net/wiki/SC####
            - No auto-fix available - manual corrections required

            ### Step 3: Find the associated PR

            Try to find the pull request associated with this commit:

            ```bash
            gh pr list --search "${{ github.event.workflow_run.head_sha }}" --state open --json number,title,url --jq '.[0]'
            ```

            If no PR is found (e.g., push to main), note this - you won't be able to comment.

            ### Step 4: Post analysis comment

            If a PR was found, post a helpful comment with your analysis. The comment should include:

            1. **Summary**: What failed and why (1-2 sentences)
            2. **Failures Found**: List each error with file, line, and explanation
            3. **How to Fix**: Specific commands or code changes

            Use this format for the comment:

            ```markdown
            ## ‚ùå CI Failure Analysis: {Workflow Name}

            **Run**: [#{run_id}]({run_url})
            **Commit**: `{sha:7}`

            ### Summary

            {Brief explanation of what failed}

            ### Failures Found

            | File | Line | Issue |
            |------|------|-------|
            | `{file}` | {line} | {description} |

            ### How to Fix

            {For markdown failures}
            **Option 1**: Auto-fix with markdownlint
            ```bash
            markdownlint "{file}" --fix
            ```

            **Option 2**: Manual fix
            {Explain specific change needed}

            {For YAML failures}
            ```bash
            uvx yamllint -c .yamllint.yml "{file}"
            ```
            - Fix indentation (use 2 spaces)
            - Remove trailing whitespace
            - Ensure newline at end of file

            {For link failures}
            - Check if URL has moved and update the link
            - Or add to `.lycheeignore` if the link is expected to fail in CI

            {For workflow validation failures}
            - Show corrected YAML syntax

            {For Ruby failures}
            **Option 1**: Auto-fix with RuboCop
            ```bash
            rubocop -a "{file}"
            ```

            **Option 2**: Manual fix
            {Explain specific change needed based on the cop violation}

            {For ShellCheck failures}
            **Manual fix required** (no auto-fix available)
            - Quote variables: `"$variable"` instead of `$variable`
            - Use `[[` instead of `[` for conditionals
            - Check ShellCheck wiki for error code: https://www.shellcheck.net/wiki/SC####
            {Explain specific change needed based on the error code}

            ---
            ü§ñ Analyzed by [Claude](https://claude.ai/code)
            ```

            Post the comment using:
            ```bash
            gh pr comment {pr_number} --body "..."
            ```

            ### Step 5: Report outcome

            After posting (or if no PR found), summarize what you found and what action was taken.

          claude_args: |
            --allowedTools "Bash(gh run:*),Bash(gh pr:*)"
